# ç”¨æˆ·æ–‡æ¡£éš”ç¦»åŠŸèƒ½æ›´æ–°è¯´æ˜

## ğŸ¯ é—®é¢˜æè¿°

åœ¨ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ï¼Œæ–‡æ¡£ä¸Šä¼ å’Œé—®ç­”åŠŸèƒ½æ˜¯å…¨å±€å…±äº«çš„ï¼Œå­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

1. **æ–‡æ¡£å…±äº«é—®é¢˜**ï¼šæ‰€æœ‰ç”¨æˆ·çš„æ–‡æ¡£éƒ½å­˜å‚¨åœ¨åŒä¸€ä¸ª ChromaDB å®ä¾‹ä¸­
2. **éšç§å®‰å…¨é£é™©**ï¼šç”¨æˆ·å¯ä»¥æŸ¥è¯¢åˆ°å…¶ä»–ç”¨æˆ·ä¸Šä¼ çš„æ–‡æ¡£å†…å®¹
3. **æ•°æ®æ··ä¹±**ï¼šä¸€ä¸ªç”¨æˆ·æ¸…é™¤æ–‡æ¡£ä¼šå½±å“æ‰€æœ‰ç”¨æˆ·

## ğŸ”§ è§£å†³æ–¹æ¡ˆ

å·²å®ç°å®Œæ•´çš„ç”¨æˆ·çº§åˆ«æ–‡æ¡£éš”ç¦»ç³»ç»Ÿï¼š

### 1. æ•°æ®å­˜å‚¨éš”ç¦»

#### å‘é‡æ•°æ®åº“éš”ç¦»
```
chroma_db/                    # åŸºç¡€ç›®å½•
â”œâ”€â”€ user_1/                  # ç”¨æˆ·1çš„å‘é‡æ•°æ®
â”‚   â”œâ”€â”€ chroma.sqlite3
â”‚   â””â”€â”€ ...
â”œâ”€â”€ user_2/                  # ç”¨æˆ·2çš„å‘é‡æ•°æ®
â”‚   â”œâ”€â”€ chroma.sqlite3
â”‚   â””â”€â”€ ...
â””â”€â”€ user_default/            # é»˜è®¤ç”¨æˆ·çš„å‘é‡æ•°æ®
    â”œâ”€â”€ chroma.sqlite3
    â””â”€â”€ ...
```

#### æ–‡ä»¶ä¸Šä¼ éš”ç¦»
```
uploads/                     # åŸºç¡€ä¸Šä¼ ç›®å½•
â”œâ”€â”€ user_1/                 # ç”¨æˆ·1çš„ä¸Šä¼ æ–‡ä»¶
â”‚   â”œâ”€â”€ document1.pdf
â”‚   â””â”€â”€ document2.docx
â”œâ”€â”€ user_2/                 # ç”¨æˆ·2çš„ä¸Šä¼ æ–‡ä»¶
â”‚   â”œâ”€â”€ guide.pdf
â”‚   â””â”€â”€ manual.txt
â””â”€â”€ user_default/           # é»˜è®¤ç”¨æˆ·çš„ä¸Šä¼ æ–‡ä»¶
    â””â”€â”€ ...
```

### 2. æ ¸å¿ƒåŠŸèƒ½æ›´æ–°

#### document_processing.py
- âœ… `get_user_chroma_path(user_id)` - è·å–ç”¨æˆ·ä¸“å±å‘é‡DBè·¯å¾„
- âœ… `init_vector_store(documents, user_id)` - ç”¨æˆ·çº§åˆ«å‘é‡å­˜å‚¨åˆå§‹åŒ–
- âœ… `clear_user_vector_store(user_id)` - æ¸…é™¤æŒ‡å®šç”¨æˆ·çš„å‘é‡æ•°æ®
- âœ… `clear_user_document_data(user_id)` - æ¸…é™¤æŒ‡å®šç”¨æˆ·çš„æ‰€æœ‰æ–‡æ¡£æ•°æ®
- âœ… `cleanup_user_vector_stores(user_id)` - æ¸…ç†ç”¨æˆ·å‘é‡å­˜å‚¨è¿æ¥

#### llm_chain.py
- âœ… `init_doc_qa_system(llm, user_id)` - ç”¨æˆ·ä¸“å±æ–‡æ¡£é—®ç­”ç³»ç»Ÿ
- âœ… æ›´æ–° `get_response()` æ”¯æŒç”¨æˆ·éš”ç¦»çš„æ–‡æ¡£é—®ç­”
- âœ… æ›´æ–° `get_response_stream()` æ”¯æŒæµå¼ç”¨æˆ·éš”ç¦»é—®ç­”
- âœ… æ›´æ–°è®°å¿†æ¸…é™¤å‡½æ•°ï¼Œåªæ¸…é™¤å¯¹åº”ç”¨æˆ·çš„æ–‡æ¡£æ•°æ®

#### main.py
- âœ… æ·»åŠ  `get_current_user_simple()` ä»è¯·æ±‚å¤´è·å–ç”¨æˆ·ID
- âœ… æ›´æ–° `/upload` ç«¯ç‚¹æ”¯æŒç”¨æˆ·çº§åˆ«æ–‡ä»¶ä¸Šä¼ 
- âœ… æ–‡ä»¶ä¿å­˜åˆ°ç”¨æˆ·ä¸“å±ç›®å½•
- âœ… ç”¨æˆ·çº§åˆ«çš„æ–‡æ¡£å¤„ç†å’Œå‘é‡åŒ–

### 3. API ä½¿ç”¨å˜æ›´

#### æ–‡æ¡£ä¸Šä¼ 
```javascript
// å‰ç«¯éœ€è¦åœ¨è¯·æ±‚å¤´ä¸­ä¼ é€’ç”¨æˆ·ID
const formData = new FormData();
formData.append('file', file);

fetch('/upload', {
  method: 'POST',
  headers: {
    'X-User-ID': userId  // æ–°å¢ï¼šç”¨æˆ·IDå¤´éƒ¨
  },
  body: formData
});
```

#### å¯¹è¯è¯·æ±‚
```javascript
// å¯¹è¯è¯·æ±‚ä¿æŒä¸å˜ï¼Œç»§ç»­ä½¿ç”¨è¯·æ±‚ä½“ä¸­çš„ user_id
fetch('/app/chat', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    message: "æ–‡æ¡£å†…å®¹æ˜¯ä»€ä¹ˆï¼Ÿ",
    function: "doc_qa",
    user_id: userId,  // ç”¨æˆ·IDåœ¨è¯·æ±‚ä½“ä¸­
    chat_history: []
  })
});
```

## ğŸ¯ åŠŸèƒ½ç‰¹æ€§

### âœ… å®Œå…¨éš”ç¦»
- æ¯ä¸ªç”¨æˆ·æ‹¥æœ‰ç‹¬ç«‹çš„å‘é‡æ•°æ®åº“å®ä¾‹
- ç”¨æˆ·åªèƒ½æŸ¥è¯¢è‡ªå·±ä¸Šä¼ çš„æ–‡æ¡£
- æ–‡æ¡£æ¸…é™¤åªå½±å“å½“å‰ç”¨æˆ·

### âœ… å‘åå…¼å®¹æ€§
- ä¿ç•™äº†åŸæœ‰çš„å…¨å±€æ¸…é™¤å‡½æ•°ï¼ˆç”¨äºç®¡ç†å‘˜æ“ä½œï¼‰
- æœªæŒ‡å®šç”¨æˆ·IDæ—¶ä½¿ç”¨ "default" ç”¨æˆ·
- ç°æœ‰APIè°ƒç”¨æ–¹å¼åŸºæœ¬ä¸å˜

### âœ… æ€§èƒ½ä¼˜åŒ–
- æŒ‰éœ€åˆ›å»ºç”¨æˆ·å‘é‡å­˜å‚¨
- ç”¨æˆ·çº§åˆ«çš„è¿æ¥æ± ç®¡ç†
- æ™ºèƒ½èµ„æºæ¸…ç†æœºåˆ¶

### âœ… é”™è¯¯å¤„ç†
- å®Œå–„çš„ç”¨æˆ·çº§åˆ«é”™è¯¯æ—¥å¿—
- ä¼˜é›…çš„èµ„æºæ¸…ç†
- å¼‚å¸¸æƒ…å†µä¸‹çš„æ•°æ®ä¿æŠ¤

## ğŸ”„ æ•°æ®è¿ç§»

å¦‚æœä½ æœ‰ç°æœ‰çš„æ–‡æ¡£æ•°æ®éœ€è¦è¿ç§»ï¼š

```python
# å¯é€‰ï¼šå°†ç°æœ‰å…¨å±€æ–‡æ¡£è¿ç§»åˆ°ç‰¹å®šç”¨æˆ·
import shutil
import os

def migrate_existing_data_to_user(user_id: str):
    """å°†ç°æœ‰å…¨å±€æ•°æ®è¿ç§»åˆ°æŒ‡å®šç”¨æˆ·"""
    old_chroma_path = "chroma_db"  # æ—§çš„å…¨å±€è·¯å¾„
    new_chroma_path = f"chroma_db/user_{user_id}"  # æ–°çš„ç”¨æˆ·è·¯å¾„
    
    if os.path.exists(old_chroma_path) and not os.path.exists(new_chroma_path):
        shutil.move(old_chroma_path, new_chroma_path)
        os.makedirs("chroma_db", exist_ok=True)  # é‡å»ºåŸºç¡€ç›®å½•
        print(f"å·²å°†ç°æœ‰æ•°æ®è¿ç§»åˆ°ç”¨æˆ· {user_id}")

# ä½¿ç”¨ç¤ºä¾‹
migrate_existing_data_to_user("admin")
```

## ğŸ§ª æµ‹è¯•éªŒè¯

ä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹æ­¥éª¤éªŒè¯éš”ç¦»åŠŸèƒ½ï¼š

1. **ç”¨æˆ·Aä¸Šä¼ æ–‡æ¡£**
   ```bash
   curl -X POST "http://localhost:8000/upload" \
     -H "X-User-ID: user_a" \
     -F "file=@document_a.pdf"
   ```

2. **ç”¨æˆ·Bä¸Šä¼ æ–‡æ¡£**
   ```bash
   curl -X POST "http://localhost:8000/upload" \
     -H "X-User-ID: user_b" \
     -F "file=@document_b.pdf"
   ```

3. **éªŒè¯éš”ç¦»æ•ˆæœ**
   - ç”¨æˆ·Aåªèƒ½æŸ¥è¯¢document_a.pdfçš„å†…å®¹
   - ç”¨æˆ·Båªèƒ½æŸ¥è¯¢document_b.pdfçš„å†…å®¹
   - ç”¨æˆ·Aæ¸…é™¤æ–‡æ¡£ä¸ä¼šå½±å“ç”¨æˆ·B

## ğŸ‰ æ€»ç»“

ç°åœ¨æ¯ä¸ªç”¨æˆ·éƒ½æ‹¥æœ‰å®Œå…¨ç‹¬ç«‹çš„æ–‡æ¡£å­˜å‚¨ç©ºé—´ï¼Œç¡®ä¿äº†ï¼š
- ğŸ“ **æ•°æ®éšç§**ï¼šç”¨æˆ·æ–‡æ¡£å®Œå…¨éš”ç¦»
- ğŸ”’ **è®¿é—®å®‰å…¨**ï¼šæ— æ³•è®¿é—®å…¶ä»–ç”¨æˆ·çš„æ–‡æ¡£
- ğŸ¯ **æ“ä½œç‹¬ç«‹**ï¼šæ–‡æ¡£æ“ä½œåªå½±å“å½“å‰ç”¨æˆ·
- âš¡ **æ€§èƒ½ä¼˜åŒ–**ï¼šæŒ‰éœ€åŠ è½½ç”¨æˆ·æ•°æ®

è¿™ä¸ªæ›´æ–°è§£å†³äº†ä¹‹å‰æ–‡æ¡£å…±äº«çš„å®‰å…¨é—®é¢˜ï¼Œä¸ºå¤šç”¨æˆ·ç¯å¢ƒæä¾›äº†å¯é çš„æ•°æ®éš”ç¦»ä¿éšœï¼
