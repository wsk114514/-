# 用户文档隔离功能更新说明

## 🎯 问题描述

在之前的版本中，文档上传和问答功能是全局共享的，存在以下问题：

1. **文档共享问题**：所有用户的文档都存储在同一个 ChromaDB 实例中
2. **隐私安全风险**：用户可以查询到其他用户上传的文档内容
3. **数据混乱**：一个用户清除文档会影响所有用户

## 🔧 解决方案

已实现完整的用户级别文档隔离系统：

### 1. 数据存储隔离

#### 向量数据库隔离
```
chroma_db/                    # 基础目录
├── user_1/                  # 用户1的向量数据
│   ├── chroma.sqlite3
│   └── ...
├── user_2/                  # 用户2的向量数据
│   ├── chroma.sqlite3
│   └── ...
└── user_default/            # 默认用户的向量数据
    ├── chroma.sqlite3
    └── ...
```

#### 文件上传隔离
```
uploads/                     # 基础上传目录
├── user_1/                 # 用户1的上传文件
│   ├── document1.pdf
│   └── document2.docx
├── user_2/                 # 用户2的上传文件
│   ├── guide.pdf
│   └── manual.txt
└── user_default/           # 默认用户的上传文件
    └── ...
```

### 2. 核心功能更新

#### document_processing.py
- ✅ `get_user_chroma_path(user_id)` - 获取用户专属向量DB路径
- ✅ `init_vector_store(documents, user_id)` - 用户级别向量存储初始化
- ✅ `clear_user_vector_store(user_id)` - 清除指定用户的向量数据
- ✅ `clear_user_document_data(user_id)` - 清除指定用户的所有文档数据
- ✅ `cleanup_user_vector_stores(user_id)` - 清理用户向量存储连接

#### llm_chain.py
- ✅ `init_doc_qa_system(llm, user_id)` - 用户专属文档问答系统
- ✅ 更新 `get_response()` 支持用户隔离的文档问答
- ✅ 更新 `get_response_stream()` 支持流式用户隔离问答
- ✅ 更新记忆清除函数，只清除对应用户的文档数据

#### main.py
- ✅ 添加 `get_current_user_simple()` 从请求头获取用户ID
- ✅ 更新 `/upload` 端点支持用户级别文件上传
- ✅ 文件保存到用户专属目录
- ✅ 用户级别的文档处理和向量化

### 3. API 使用变更

#### 文档上传
```javascript
// 前端需要在请求头中传递用户ID
const formData = new FormData();
formData.append('file', file);

fetch('/upload', {
  method: 'POST',
  headers: {
    'X-User-ID': userId  // 新增：用户ID头部
  },
  body: formData
});
```

#### 对话请求
```javascript
// 对话请求保持不变，继续使用请求体中的 user_id
fetch('/app/chat', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    message: "文档内容是什么？",
    function: "doc_qa",
    user_id: userId,  // 用户ID在请求体中
    chat_history: []
  })
});
```

## 🎯 功能特性

### ✅ 完全隔离
- 每个用户拥有独立的向量数据库实例
- 用户只能查询自己上传的文档
- 文档清除只影响当前用户

### ✅ 向后兼容性
- 保留了原有的全局清除函数（用于管理员操作）
- 未指定用户ID时使用 "default" 用户
- 现有API调用方式基本不变

### ✅ 性能优化
- 按需创建用户向量存储
- 用户级别的连接池管理
- 智能资源清理机制

### ✅ 错误处理
- 完善的用户级别错误日志
- 优雅的资源清理
- 异常情况下的数据保护

## 🔄 数据迁移

如果你有现有的文档数据需要迁移：

```python
# 可选：将现有全局文档迁移到特定用户
import shutil
import os

def migrate_existing_data_to_user(user_id: str):
    """将现有全局数据迁移到指定用户"""
    old_chroma_path = "chroma_db"  # 旧的全局路径
    new_chroma_path = f"chroma_db/user_{user_id}"  # 新的用户路径
    
    if os.path.exists(old_chroma_path) and not os.path.exists(new_chroma_path):
        shutil.move(old_chroma_path, new_chroma_path)
        os.makedirs("chroma_db", exist_ok=True)  # 重建基础目录
        print(f"已将现有数据迁移到用户 {user_id}")

# 使用示例
migrate_existing_data_to_user("admin")
```

## 🧪 测试验证

你可以通过以下步骤验证隔离功能：

1. **用户A上传文档**
   ```bash
   curl -X POST "http://localhost:8000/upload" \
     -H "X-User-ID: user_a" \
     -F "file=@document_a.pdf"
   ```

2. **用户B上传文档**
   ```bash
   curl -X POST "http://localhost:8000/upload" \
     -H "X-User-ID: user_b" \
     -F "file=@document_b.pdf"
   ```

3. **验证隔离效果**
   - 用户A只能查询document_a.pdf的内容
   - 用户B只能查询document_b.pdf的内容
   - 用户A清除文档不会影响用户B

## 🎉 总结

现在每个用户都拥有完全独立的文档存储空间，确保了：
- 📁 **数据隐私**：用户文档完全隔离
- 🔒 **访问安全**：无法访问其他用户的文档
- 🎯 **操作独立**：文档操作只影响当前用户
- ⚡ **性能优化**：按需加载用户数据

这个更新解决了之前文档共享的安全问题，为多用户环境提供了可靠的数据隔离保障！
